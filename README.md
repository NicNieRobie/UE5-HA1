# Home Assignment 1

Разработчик: Пендищук Владислав

*(Задание сделано за два вечера, "спасибо" ИАДу)*


# Описание проекта

В проекте выполнены все основные требования к работе, а именно:

 - Система перемещения персонажа (взята из Third Person Template)
 - Наличие здоровья у персонажа
 - Процедурная генерация комнат и ловушек
 - Вариация в уровнях сложности
 - Наличие всех описанных в ТЗ баффов и дебаффов
 - Спавн аптечек в "сложных" комнатах
 - Настройка основных параметров игры через Data Table

## Алгоритм генерации комнат

Алгоритм генерации комнат создаёт оные при помощи модульных статических мешей из Starter Content, вычисляя перед этим необходимый для вмещения сгенерированных ловушек размер комнаты. Алгоритм имеет следующий яд основных параметром:

 - Количество тайлов по Х - количество "блоков" 400 на 400, из которых состоит комната, по оси X;
 - Количество тайлов по Х - количество "блоков" 400 на 400, из которых состоит комната, по оси Y;
 - Тип входа в комнату - левый (вход слева), правый (вход справа) или none (входа нет);
 - Тип выхода из комнаты - существует или не существует (у последней комнаты);
 - Сложность комнаты - целое число, определяющее количество ловушек в комнате;
 - Вероятность спавна баффа - self-explanatory;
 - Вероятность спавна дебаффа - self-explanatory;
 - Флаг необходимости спавна аптечки;
 - Флаг, обозначающий, является ли комната последней.

Все комнаты в игре представлены объектами BP_Room. Центральный метод в генерации комнаты - метод BuildRoom.

![Функции BP_Room](https://i.imgur.com/XuaAn6e.jpg)

Данный метод поочерёдно:

 - Формирует пол и стены из Instanced Static Mesh'ей;
 - Случайно определяет, какая из следующих комнат будет сложнее, генерируя сложности левой и правой комнат;
 - Добавляет двери исходя из типов входа и выхода из комнаты (метод ResolveDoorsAndPathways);
 - Корректирует расположение и размеры триггеров (SetupTriggerCollision);
 - Спавнит камень, если комната последняя (SetupFinish).

Все комнаты в игре имеют ширину в 6 тайлов. Это сделано для облегчения процесса расположения ловушек и других объектов внутри комнаты.

В случае, если комната последняя, её длина также составляет 6 тайлов. Иначе, она определяется методом, формирующем ловушки - SetupTraps. Данный метод:

 - Спавнит ловушки - их количество вычисляется по формуле (Difficulty / 3) + 1 - таким образом, на каждый третий уровень сложности приходится спавн ещё одной ловушки в комнате;
 - Перед ловушками и в промежутках между ними (длиной в один тайл) помещает PickupSpawnManager'ы - объекты, отвечающие за спавн пикапов (баффов, дебаффов, аптечек);
 - Вычисляет необходимый для размещения ловушек размер комнаты.
 
 После спавна ловушек срабатывает функция SetupPickups, которая:
 
 - Спавнит аптечку, если это необходимо (в случае, когда комната "сложная");
 - Спавнит бафф с заданной вероятностью;
 - Спавнит дебафф с заданной вероятностью.
 
При этом "случайный" пикап с неопределённым эффектом генерируется вместо баффа или дебаффа. Для спавна каждого пикапа выбирается случайный PickupSpawnManager, каждый из которых отвечает за свой участок в комнате без ловушек. Данный объект спавнит запрошенный пикап в своей зоне.

При генерации комнаты в ней создаётся два Box'а коллизии, используемые в роли триггеров:

 - Первый из них, RoomBox, содержит в себе почти всю комнату (с малыми отступами от передней и задней стен во избежание багов коллизии с игроком в другой комнате). Данный бокс фиксирует появление игрока в комнате, передаёт информацию об этом в гейммод и по прошествии 1.1 секунды уничтожает все комнаты, кроме следующих. Это сделано для очистки памяти от множества не нужных акторов и мешей. При этом используются методы Destroy-.
 - Второй, ExitBox, расположен в самом конце комнаты и используется для генерации следующих комнат, как только игрок добирается до выходов из комнат.
 
## Алгоритм генерации ловушек

Каждая ловушка реализовывает интерфейс BPI_Trap и BPI_DynamicTrap. Данные интерфейсы используются для коммуникации между комнатами и ловушками внутри них. Всего в игре представлены 4 вида ловушек:

- BP_MovingPlatforms - набор платформ, перемещающихся в воздухе вдоль ширины комнаты. Нахождение игрока на поверхности под платформами наносит персонажу урон.
- BP_SpinningTrap - несколько рядов вращающихся на опорах цилиндров, наносящих урон при прикосновении к персонажу.
- BP_SpearTrap - несколько рядов отверстий, из через регулярный интервал выходит копье, наносящее урон персонажу при прикосновении.
- BP_MovingSpinningTrap - несколько вращающихся на опорах цилиндров, перемещающихся вдоль ширины комнаты и наносящих урон при прикосновении к персонажу.

Каждая ловушка имеет следующие параметры:

 - Difficulty - сложность ловушки;
 - SpeedMultiplier - мультипликатор скорости движения движущихся частей ловушек.

Каждая ловушка состоит из ряда акторов и Instanced Static Mesh'ей. Сложность ловушек состоит из таких параметров, как:

 - Количество платформ (для BP_MovingPlatforms);
 - Количество рядов ловушек (для всех остальных);
 - Скорость движения ловушек.
 
Сложности ловушек равны сложности комнаты, в которой они были сгенерированы. Для вычисления вышеуказанных характеристик из сложности ловушки используются методы ConfigureDifficulty. Каждый уровень сложности добавляет 0.1 к множителю скорости, а каждый третий уровень увеличивает ловушку.

Каждая ловушка имеет функции ConstructTrap(s) и DeconstructTrap(s). Они отвечают за создание и удаление акторов, составляющих ловушку, соответственно.

Для передачи данных между ловушками и комнатами, их содержащими, используются методы интерфейсов BPI_Trap и BPI_DynamicTrap, переопределяемые каждым классом ловушек:

- GetLength - возвращает длину ловушки по оси X, необходим для корректного размещения ловушек внутри комнаты;
- GetReuiredHeight - возвращает значение по оси Z, на которое необходимо поднять данную ловушку от поверхности;
- SetDifficulty - используется для установки уровня сложности ловушкам при генерации оных внутри комнаты;
- DestroyTrap - уничтожает ловушку, используется при очистке ненужных комнат.
- GetSpeedMultiplier и SetSpeedMultiplier - методы BPI_DynamicTrap, возвращает и устанавливает множитель скорости движущихся частей ловушки соответственно.

Для нанесения урона персонажу ловушки используют коллизию.

## Сложность

Сложность в игре обозначается натуральным числом и является характеристикой комнат, передающейся от них к генерируемым ими ловушкам.

При генерации комнат, одна из комнат получает ту же сложность, что и текущая, а другая получает сложность, выше на единицу. Такая комната обозначена надписью DANGER над дверью.

Как уже было обозначено выше, каждый уровень сложности добавляет 0.1 к множителю скорости ловушек, а каждый третий уровень увеличивает ловушки на одну их "элементарную единицу" (ряд копий, платформа и т.д).

Дополнительно сложность можно считать обусловленной шансами спавна баффа и дебаффа в данной комнате. При генерации следующих за текущей комнат, данные шансы изменяются следующим образом:

 - Комната, сложность которой выше, получает шанс на спавн баффа, равный шансу на спавн баффа в данной комнате, умноженному на 1.5. Шанс спавна дебаффа же в сложной комнате уменьшается на четверть.
 - Комната, сложность которой ниже, получает ровно обратный эффект - шанс на спавн баффа падает на четверть, шанс на спавн дебаффа увеличивается в 1.5 раза.

## Что реализовано сверх условий

Ничего :( 
*(не успел)*

## Ссылки на проекты, откуда был взят код

https://gitlab.com/nikita.veselko/hse_22 - работа с занятия по UMG была использована на референс по теме настроек параметров через CSV.
